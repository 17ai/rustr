language: rust
# necessary for `travis-cargo coveralls --no-sudo`
addons:
  apt:
    packages:
      - libcurl4-openssl-dev
      - libelf-dev
      - libdw-dev

os:
  - linux
  - osx

sudo: required
dist: trusty

# run builds for all the trains (and more)
rust:
  - nightly
  - beta
  - stable

matrix:
    allow_failures:
      rust:
        - beta
        - stable

before_install:
  - curl -OL http://raw.github.com/craigcitro/r-travis/master/scripts/travis-tool.sh
  - chmod 755 ./travis-tool.sh
  - ./travis-tool.sh bootstrap
  - ./travis-tool.sh install_r_binary Rcpp RCurl stringi dplyr curl jsonlite yaml tidyr markdown


# load travis-cargo
# before_script:
#   - |
#       pip install 'travis-cargo<0.2' --user &&
#       export PATH=$HOME/.local/bin:$PATH
# the main build
script:
  - if [[ "Darwin" == "$(uname -s)" ]]; then export RLIBPATH="/Library/Frameworks/R.framework/Resources/lib";curl -O http://r.research.att.com/libs/gfortran-4.8.2-darwin13.tar.bz2;sudo tar fvxz gfortran-4.8.2-darwin13.tar.bz2 -C /;fi
  # - cargo build --features "$FEATURE"
  # - cargo test  --verbose --features "$FEATURE"
  - cd rtest
  - ../travis-tool.sh install_deps
  - ../travis-tool.sh run_tests
  - cd ..
  - export R_HOME=$(Rscript -e "cat(R.home())")
  - export RUST_TEST_THREADS=1
  - cargo test --features "engine"
  
env:
  global:
    # override the default `--features unstable` used for the nightly branch (optional)
    - FEATURE="date engine random logging"

after_failure:
  - cd rtest
  - ../travis-tool.sh dump_logs

notifications:
  email:
    on_success: change
    on_failure: change
